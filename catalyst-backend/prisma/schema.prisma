// Catalyst Backend - Prisma Schema
datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

// ============================================================================
// USERS & AUTHENTICATION
// ============================================================================

model User {
  id            String   @id @default(cuid())
  email         String   @unique
  name          String
  emailVerified Boolean  @default(false)
  image         String?
  twoFactorEnabled Boolean @default(false)
  role          String?
  banned        Boolean  @default(false)
  banReason     String?
  banExpires    DateTime?
  username      String   @unique
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  accounts   account[]
  sessions   session[]
  twoFactor  twoFactor[]
  passkeys   passkey[]
  roles      Role[]
  servers    ServerAccess[]
  auditLog   AuditLog[]
  invitesSent ServerAccessInvite[] @relation("ServerInviteSender")
  alertRules AlertRule[]
  alerts     Alert[]
}

model session {
  id        String   @id @default(cuid())
  expiresAt DateTime
  token     String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  ipAddress String?
  userAgent String?

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
}

model account {
  id                    String   @id @default(cuid())
  accountId             String
  providerId            String
  userId                String
  user                  User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  accessToken           String?
  refreshToken          String?
  idToken               String?
  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scope                 String?
  password              String?
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  @@unique([providerId, accountId])
  @@index([userId])
}

model jwks {
  id         String   @id @default(cuid())
  publicKey  String
  privateKey String
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
}

model passkey {
  id           String   @id @default(cuid())
  name         String?
  publicKey    String
  userId       String
  credentialID String
  counter      Int
  deviceType   String
  backedUp     Boolean
  transports   String?
  createdAt    DateTime @default(now())
  aaguid       String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([credentialID])
}

model verification {
  id         String   @id @default(cuid())
  identifier String
  value      String
  expiresAt  DateTime
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([identifier])
  @@index([expiresAt])
}
model twoFactor {
  id          String   @id @default(cuid())
  secret      String
  backupCodes String
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([secret])
  @@index([userId])
}


// ============================================================================
// ROLES & PERMISSIONS
// ============================================================================

model Role {
  id          String   @id @default(cuid())
  name        String   @unique
  description String?
  permissions String[] // Permission enum values
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  users       User[]
  serverRoles ServerRole[]
}

model ServerRole {
  id        String   @id @default(cuid())
  serverId  String
  server    Server   @relation(fields: [serverId], references: [id], onDelete: Cascade)
  roleId    String
  role      Role     @relation(fields: [roleId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())

  @@unique([serverId, roleId])
}

model ServerAccess {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  serverId  String
  server    Server   @relation(fields: [serverId], references: [id], onDelete: Cascade)
  permissions String[] // Permission enum values
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, serverId])
  @@index([serverId, userId])
}

model ServerAccessInvite {
  id              String   @id @default(cuid())
  serverId        String
  server          Server   @relation(fields: [serverId], references: [id], onDelete: Cascade)
  email           String
  token           String   @unique
  permissions     String[]
  invitedByUserId String
  invitedByUser   User     @relation("ServerInviteSender", fields: [invitedByUserId], references: [id], onDelete: Cascade)
  createdAt       DateTime @default(now())
  expiresAt       DateTime
  acceptedAt      DateTime?
  cancelledAt     DateTime?

  @@index([serverId, email])
  @@index([expiresAt])
}

model SystemSetting {
  id                 String   @id
  smtpHost           String?
  smtpPort           Int?
  smtpUsername       String?
  smtpPassword       String?
  smtpFrom           String?
  smtpReplyTo        String?
  smtpSecure         Boolean  @default(false)
  smtpRequireTls     Boolean  @default(false)
  smtpPool           Boolean  @default(false)
  smtpMaxConnections Int?
  smtpMaxMessages    Int?
  curseforgeApiKey   String?
  modrinthApiKey     String?
  authRateLimitMax         Int?
  fileRateLimitMax         Int?
  consoleRateLimitMax      Int?
  lockoutMaxAttempts       Int?
  lockoutWindowMinutes     Int?
  lockoutDurationMinutes   Int?
  auditRetentionDays       Int?
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt
}

// ============================================================================
// INFRASTRUCTURE
// ============================================================================

model Location {
  id          String   @id @default(cuid())
  name        String   @unique
  description String?
  createdAt   DateTime @default(now())

  nodes   Node[]
  servers Server[]
}

model Node {
  id             String   @id @default(cuid())
  name           String   @unique
  description    String?
  locationId     String
  location       Location @relation(fields: [locationId], references: [id], onDelete: Cascade)
  hostname       String
  publicAddress  String
  secret         String   @unique
  maxMemoryMb    Int
  maxCpuCores    Int
  isOnline       Boolean  @default(false)
  lastSeenAt     DateTime?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  servers    Server[]
  deploymentTokens DeploymentToken[]
  metrics    NodeMetrics[]
  alerts     Alert[]
  ipPools    IpPool[]
  allocations NodeAllocation[]
}

model IpPool {
  id          String   @id @default(cuid())
  nodeId      String
  node        Node     @relation(fields: [nodeId], references: [id], onDelete: Cascade)
  networkName String
  cidr        String
  gateway     String?
  startIp     String?
  endIp       String?
  reserved    Json     @default("[]") // array of IP strings
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  allocations IpAllocation[]

  @@unique([nodeId, networkName])
}

model IpAllocation {
  id         String   @id @default(cuid())
  poolId     String
  pool       IpPool   @relation(fields: [poolId], references: [id], onDelete: Cascade)
  serverId   String?  @unique
  server     Server?  @relation(fields: [serverId], references: [id], onDelete: Cascade)
  ip         String
  createdAt  DateTime @default(now())
  releasedAt DateTime?

  @@unique([poolId, ip])
  @@index([serverId])
}

model NodeAllocation {
  id        String   @id @default(cuid())
  nodeId    String
  node      Node     @relation(fields: [nodeId], references: [id], onDelete: Cascade)
  serverId  String?
  server    Server?  @relation(fields: [serverId], references: [id], onDelete: SetNull)
  ip        String
  port      Int
  alias     String?
  notes     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([nodeId, ip, port])
  @@index([serverId])
}

model DeploymentToken {
  id        String   @id @default(cuid())
  nodeId    String
  node      Node     @relation(fields: [nodeId], references: [id], onDelete: Cascade)
  token     String   @unique
  secret    String   @unique
  expiresAt DateTime
  usedAt    DateTime?
  createdAt DateTime @default(now())
}

// ============================================================================
// TEMPLATES
// ============================================================================

model ServerTemplate {
  id                 String   @id @default(cuid())
  name               String   @unique
  description        String?
  author             String
  version            String
  image              String
  images             Json     @default("[]")
  defaultImage       String?
  installImage       String?
  startup            String
  stopCommand        String
  sendSignalTo       String   @default("SIGTERM")
  variables          Json     // Array of EnvironmentVariable
  installScript      String?
  supportedPorts     Int[]
  allocatedMemoryMb  Int
  allocatedCpuCores Int
  features           Json     @default("{}")
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  servers Server[]
}

// ============================================================================
// SERVERS
// ============================================================================

model Server {
  id             String   @id @default(cuid())
  uuid           String   @unique
  name           String
  description    String?
  templateId     String
  template       ServerTemplate @relation(fields: [templateId], references: [id])
  nodeId         String
  node           Node     @relation(fields: [nodeId], references: [id], onDelete: Cascade)
  locationId     String
  location       Location @relation(fields: [locationId], references: [id])
  ownerId        String
  status         String   @default("stopped")
  suspendedAt    DateTime?
  suspendedByUserId String?
  suspensionReason String?
  allocatedMemoryMb Int
  allocatedCpuCores Int
  allocatedDiskMb  Int     @default(10240)
  
  // Container info
  containerId    String?
  containerName  String?
  
  // Networking
  networkMode    String   @default("bridge")
  primaryPort    Int
  primaryIp      String?
  portBindings   Json     @default("{}") // Record<number, number>
  
  // Configuration
  environment    Json     @default("{}")

  // Backups
  backupStorageMode   String   @default("local") // local, s3, stream
  backupRetentionCount Int     @default(0)
  backupRetentionDays  Int     @default(0)
  backupAllocationMb  Int     @default(0)
  databaseAllocation  Int     @default(0)
  backupS3Config      Json    @default("{}")
  backupSftpConfig    Json    @default("{}")
  
  // Crash detection & auto-restart
  restartPolicy  String   @default("on-failure") // always, on-failure, never
  crashCount     Int      @default(0)
  maxCrashCount  Int      @default(5)
  lastCrashAt    DateTime?
  lastExitCode   Int?
  
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  access         ServerAccess[]
  invites        ServerAccessInvite[]
  roles          ServerRole[]
  logs           ServerLog[]
  metrics        ServerMetrics[]
  backups        Backup[]
  databases      ServerDatabase[]
  scheduledTasks ScheduledTask[]
  alerts         Alert[]
  ipAllocation   IpAllocation?
  allocations    NodeAllocation[]
}

// ============================================================================
// DATABASES
// ============================================================================

model DatabaseHost {
  id        String   @id @default(cuid())
  name      String   @unique
  host      String
  port      Int      @default(3306)
  username  String
  password  String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  databases ServerDatabase[]
}

model ServerDatabase {
  id        String   @id @default(cuid())
  serverId  String
  server    Server   @relation(fields: [serverId], references: [id], onDelete: Cascade)
  hostId    String
  host      DatabaseHost @relation(fields: [hostId], references: [id], onDelete: Cascade)
  name      String
  username  String
  password  String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([hostId, name])
  @@unique([hostId, username])
  @@index([serverId])
}

model Backup {
  id          String   @id @default(cuid())
  serverId    String
  server      Server   @relation(fields: [serverId], references: [id], onDelete: Cascade)
  name        String
  path        String   // File path on disk or S3 URL
  storageMode String   @default("local")
  sizeMb      Float
  compressed  Boolean  @default(true)
  checksum    String?  // SHA256 checksum for integrity
  metadata    Json     @default("{}")  // Server config snapshot
  createdAt   DateTime @default(now())
  restoredAt  DateTime?

  @@index([serverId, createdAt])
}

model ScheduledTask {
  id          String   @id @default(cuid())
  serverId    String
  server      Server   @relation(fields: [serverId], references: [id], onDelete: Cascade)
  name        String
  description String?
  action      String   // restart, stop, start, backup, command
  payload     Json?    // Additional data (e.g., command to run)
  schedule    String   // Cron expression (e.g., "0 3 * * *" for 3 AM daily)
  enabled     Boolean  @default(true)
  lastRunAt   DateTime?
  nextRunAt   DateTime?
  lastStatus  String?  // success, failed, skipped
  lastError   String?
  runCount    Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([serverId, enabled])
  @@index([enabled, nextRunAt])
}

model ServerLog {
  id        String   @id @default(cuid())
  serverId  String
  server    Server   @relation(fields: [serverId], references: [id], onDelete: Cascade)
  stream    String   @default("stdout") // stdout, stderr, system
  data      String   @db.Text
  timestamp DateTime @default(now())

  @@index([serverId, timestamp])
}

// ============================================================================
// AUDIT LOG
// ============================================================================

model AuditLog {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: SetNull)
  action    String
  resource  String
  resourceId String?
  details   Json?
  timestamp DateTime @default(now())

  @@index([userId, timestamp])
}

model AuthLockout {
  id            String   @id @default(cuid())
  email         String
  ipAddress     String
  userAgent     String?
  failureCount  Int      @default(0)
  firstFailedAt DateTime
  lastFailedAt  DateTime
  lockedUntil   DateTime?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@unique([email, ipAddress])
  @@index([email])
  @@index([lockedUntil])
}

// ============================================================================
// RESOURCE MONITORING
// ============================================================================

model ServerMetrics {
  id            String   @id @default(cuid())
  serverId      String
  server        Server   @relation(fields: [serverId], references: [id], onDelete: Cascade)
  cpuPercent    Float
  memoryUsageMb Int
  networkRxBytes BigInt
  networkTxBytes BigInt
  diskIoMb      Int      @default(0)
  diskUsageMb   Int
  timestamp     DateTime @default(now())
  
  @@index([serverId, timestamp])
  @@unique([serverId, timestamp])
}

model NodeMetrics {
  id                String   @id @default(cuid())
  nodeId            String
  node              Node     @relation(fields: [nodeId], references: [id], onDelete: Cascade)
  cpuPercent        Float
  memoryUsageMb     Int
  memoryTotalMb     Int
  diskUsageMb       Int
  diskTotalMb       Int
  networkRxBytes    BigInt
  networkTxBytes    BigInt
  containerCount    Int
  timestamp         DateTime @default(now())
  
  @@index([nodeId, timestamp])
}

model Alert {
  id          String   @id @default(cuid())
  ruleId      String?
  rule        AlertRule? @relation(fields: [ruleId], references: [id], onDelete: SetNull)
  userId      String?
  user        User?    @relation(fields: [userId], references: [id], onDelete: SetNull)
  serverId    String?
  server      Server?  @relation(fields: [serverId], references: [id], onDelete: Cascade)
  nodeId      String?
  node        Node?    @relation(fields: [nodeId], references: [id], onDelete: Cascade)
  type        String   // resource_threshold, node_offline, server_crashed, custom
  severity    String   // info, warning, critical
  title       String
  message     String   @db.Text
  metadata    Json     @default("{}")
  resolved    Boolean  @default(false)
  resolvedAt  DateTime?
  resolvedBy  String?
  createdAt   DateTime @default(now())
  deliveries  AlertDelivery[]

  @@index([serverId, resolved, createdAt])
  @@index([nodeId, resolved, createdAt])
  @@index([type, severity, resolved])
  @@index([ruleId, createdAt])
  @@index([userId, resolved, createdAt])
}

model AlertRule {
  id          String   @id @default(cuid())
  name        String
  description String?
  enabled     Boolean  @default(true)
  type        String   // resource_threshold, node_offline, server_crashed
  target      String   // server, node, global
  targetId    String?  // Specific server/node ID, or null for global
  userId      String?
  user        User?    @relation(fields: [userId], references: [id], onDelete: SetNull)
  conditions  Json     // Threshold values, etc.
  actions     Json     // Webhook URLs, notification methods
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  alerts      Alert[]

  @@index([enabled, type])
  @@index([target, targetId])
  @@index([userId, createdAt])
}

model AlertDelivery {
  id            String   @id @default(cuid())
  alertId       String
  alert         Alert    @relation(fields: [alertId], references: [id], onDelete: Cascade)
  channel       String   // email, webhook
  target        String
  status        String   @default("pending") // pending, sent, failed
  attempts      Int      @default(0)
  lastAttemptAt DateTime?
  lastError     String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([alertId, status])
  @@index([channel, status])
}
